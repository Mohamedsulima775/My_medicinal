# -*- coding: utf-8 -*-
# Copyright (c) 2025, Mohammed and contributors
# For license information, please see license.txt

from __future__ import unicode_literals
import frappe
from frappe import _
from frappe.model.document import Document
from frappe.utils import now_datetime, getdate, get_datetime, date_diff, today
import json

class patient(Document):



   """patient DocType - ????? ?????? ??????"""

     def before_insert(self):
     
     """??? ??????? - ?????? ?? ????????"""
      self.validate_mobile()
      self.validate_email()
      self.validate_national_id()
	
	def after_insert(self):
  """??? ??????? - ????? User ??? ?? ??? ???????"""
		if not self.user:
			self.create_user_account()
	
	def validate(self):
		"""?????? ?? ??? ????????"""
		self.validate_mobile()
		self.validate_email()
		self.validate_age()
		self.set_age_if_dob()
		self.validate_status()
	
	def validate_mobile(self):
			"""?????? ?? ??? ??????"""
		if not self.mobile:
			frappe.throw(_("Mobile number required"))
		
				# ?????? ?? ??????? (????: ???? ?? 05)
		if len(self.mobile) != 10:
			frappe.throw(_("The mobile number must be 10 digits"))
		
		if not self.mobile.startswith('05'):
			frappe.throw(_("The mobile number must be begin with 05"))
		
		# ?????? ?? ??? ???????
		if self.is_new():
			if frappe.db.exists("Patient", {"mobile": self.mobile}):
				frappe.throw(_("The mobile number already exists").format(self.mobile))
	
	def validate_email(self):
				"""?????? ?? ?????? ??????????"""
		if self.email:
			# ?????? ?? ???????
			import re
			email_pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
			if not re.match(email_pattern, self.email):
				frappe.throw(_("Invalid email address"))
	
	def validate_national_id(self):
	   """?????? ?? ??? ??????"""
		if self.national_id:
			# ?????? ?? ???????
			if self.is_new():
				if frappe.db.exists("Patient", {"national_id": self.national_id}):
					frappe.throw(_("The National number already exists").format(self.national_id))
	
	def validate_age(self):
    """?????? ?? ?????"""

		if self.date_of_birth:
			age = self.get_age()
			if age < 0:
				frappe.throw(_("Incorrect date of birth"))
			if age > 150:
				frappe.throw(_("The birth date is illogical"))
	
	def set_age_if_dob(self):
   	"""???? ????? ?? ????? ???????"""

		if self.date_of_birth:
			self.age = self.get_age()
	
	def validate_status(self):
				"""?????? ?? ??????"""
		if not self.status:
			self.status = "???"
	
	def get_age(self):
				"""???? ????? ????????"""
		if not self.date_of_birth:
			return None
		
		dob = getdate(self.date_of_birth)
		today_date = getdate(today())
		age = date_diff(today_date, dob) / 365.25
		return int(age)
#------------------------------------------------------------------------------
#-----------------------------100%________________________	
 
 
	def create_user_account(self):
				"""????? ???? ?????? ??????"""
		try:
					# ????? User
			user = frappe.get_doc({
				"doctype": "User",
				"email": self.email or f"{self.mobile}@patients.local",
				"first_name": self.patient_name,
				"mobile_no": self.mobile,
				"user_type": "Website User",
				"send_welcome_email": 0
			})
			user.insert(ignore_permissions=True)
			
						# ????? ??? ??????
			user.add_roles("Patient")
			
						# ??? User ???????
			self.db_set("user", user.name, update_modified=False)
			
			frappe.msgprint(_("?? ????? ???? ?????? ??????"))

			
		except Exception as e:
			frappe.log_error(frappe.get_traceback(), "Create Patient User Error")
	
	def on_update(self):
		"""??? ???????"""
		self.update_user_details()
	
	def update_user_details(self):
		"""????? ?????? ????????"""
		if self.user:
			user = frappe.get_doc("User", self.user)
			
			# ????? ???????? ????????
			user.first_name = self.patient_name
			user.mobile_no = self.mobile
			
			if self.email and user.email != self.email:
				user.email = self.email
			
			user.save(ignore_permissions=True)
	
	def on_trash(self):
		"""??? ?????"""
		# ??? ???????? ???????? (???????)
		self.delete_related_records()
	
	def delete_related_records(self):
		"""??? ??????? ????????"""
		# ??? Medication Schedules
		medication_schedules = frappe.get_all(
			"Medication Schedule",
			filters={"patient": self.name}
		)
		for schedule in medication_schedules:
			frappe.delete_doc("Medication Schedule", schedule.name, ignore_permissions=True)
		
		# ??? Medication Logs
		frappe.db.delete("Medication Log", {"patient": self.name})
		
		# ??? Consultations
		frappe.db.delete("Medical Consultation", {"patient": self.name})
	
	def get_medications_count(self):
		"""??? ??????? ??????"""
		return frappe.db.count("Medication Schedule", {"patient": self.name})
	
	def get_active_prescriptions(self):
		"""??????? ??????"""
		return frappe.get_all(
			"Medical Prescription",
			filters={
				"patient": self.name,
				"status": "active"
			},
			fields=["name", "doctor", "prescription_date"]
		)
	
	def get_adherence_rate(self, days=30):
		"""???? ???????? ???????"""
		from datetime import timedelta
		from_date = get_datetime(now_datetime()) - timedelta(days=days)
		
		# ?????? ???????? ????????
		total_expected = frappe.db.count(
			"Medication Log",
			filters={
				"patient": self.name,
				"creation": [">=", from_date]
			}
		)
		
		if total_expected == 0:
			return 0
		
		# ??? ?????? ???? ?? ???? ???????
		taken_count = frappe.db.count(
			"Medication Log",
			filters={
				"patient": self.name,
				"status": "taken",
				"creation": [">=", from_date]
			}
		)
		
		adherence_rate = (taken_count / total_expected) * 100
		return round(adherence_rate, 2)
	
	def get_chronic_diseases_list(self):
		"""????? ??????? ???????"""
		return [d.disease for d in self.chronic_diseases]
	
	def has_allergy(self, substance):
		"""?????? ?? ???? ??????"""
		if not self.allergies:
			return False
		return substance.lower() in self.allergies.lower()

# ============================================
# API Methods - ???? ????????? ?? ??? Frontend
# ============================================

@frappe.whitelist()
def get_patient_summary(patient_id):
	"""?????? ??? ???? ?????? ??????"""
	try:
		patient = frappe.get_doc("Patient", patient_id)
		
		summary = {
			"patient_name": patient.patient_name,
			"mobile": patient.mobile,
			"email": patient.email,
			"age": patient.get_age(),
			"gender": patient.gender,
			"blood_group": patient.blood_group,
			"status": patient.status,
			"profile_image": patient.profile_image,
			"chronic_diseases": patient.get_chronic_diseases_list(),
			"medications_count": patient.get_medications_count(),
			"adherence_rate": patient.get_adherence_rate(),
			"active_prescriptions": patient.get_active_prescriptions()
		}
		
		return {
			"success": True,
			"data": summary
		}
	
	except Exception as e:
		frappe.log_error(frappe.get_traceback(), "Get Patient Summary Error")
		return {
			"success": False,
			"message": str(e)
		}


@frappe.whitelist()
def update_patient_profile(patient_id, data):
	"""????? ?????? ??????"""
	try:
		patient = frappe.get_doc("Patient", patient_id)
		
		# ????? ????????
		if isinstance(data, str):
			data = json.loads(data)
		
		for key, value in data.items():
			if hasattr(patient, key):
				setattr(patient, key, value)
		
		patient.save()
		
		return {
			"success": True,
			"message": "?? ????? ???????? ?????"
		}
	
	except Exception as e:
		frappe.log_error(frappe.get_traceback(), "Update Patient Profile Error")
		return {
			"success": False,
			"message": str(e)
		}


@frappe.whitelist()
def check_patient_allergies(patient_id, medication_name):
	"""?????? ?? ????????? ??? ????? ????"""
	try:
		patient = frappe.get_doc("Patient", patient_id)
		
		if not patient.allergies:
			return {
				"success": True,
				"has_allergy": False,
				"message": "?? ???? ??????? ?????"
			}
		
		# ????? ?? ??????? ??????
		allergies_list = [a.strip().lower() for a in patient.allergies.split(',')]
		medication_lower = medication_name.lower()
		
		has_allergy = any(allergy in medication_lower for allergy in allergies_list)
		
		return {
			"success": True,
			"has_allergy": has_allergy,
			"allergies": patient.allergies if has_allergy else None,
			"message": "?? ?????: ?? ???? ??? ?????? ??????!" if has_allergy else "???"
		}
	
	except Exception as e:
		frappe.log_error(frappe.get_traceback(), "Check Patient Allergies Error")
		return {
			"success": False,
			"message": str(e)
		}


# ============================================
# Hooks - ??? ????????? ????????
# ============================================

def on_session_creation(login_manager):
	"""??? ????? ??????"""
	# ?????? ??? ??????? ??????
	user = login_manager.user
	
	patient = frappe.db.get_value("Patient", {"user": user}, "name")
	
	if patient:
		# ????? ??? ????
		frappe.db.set_value("Patient", patient, "last_login", now_datetime())


def daily_reminder():
	"""????? ???? ?????? (??????? ?? Scheduled Job)"""
	# ?????? ??? ???? ?????? ???????
	patients = frappe.get_all(
		"Patient",
		filters={"status": "???"},
		fields=["name", "patient_name", "mobile", "user"]
	)
	
	for patient in patients:
		# ????? ?????
		send_daily_reminder(patient.name)


def send_daily_reminder(patient_id):
	"""????? ????? ???? ????? ????"""
	# TODO: ????? ???? ?????????
	pass