// Copyright (c) 2025, Mohammed and contributors
// For license information, please see license.txt

frappe.ui.form.on('Patient', {
	// ============================================
	// Form Events
	// ============================================
	
	refresh: function(frm) {
		// ????? ?????? ??? ??? ???????
		setup_custom_buttons(frm);
		setup_indicators(frm);
		setup_dashboard(frm);
		apply_permissions(frm);
		
		// ?????/????? ???? ??? ??????
		toggle_fields_based_on_status(frm);
	},
	
	onload: function(frm) {
		// ??? ????? ??????? ???? ???
		set_queries(frm);
		
		// ??? ??? ????? ????
		if (frm.is_new()) {
			frm.set_value('status', 'Active');
		}
	},
	
	before_save: function(frm) {
		// ??? ????? - ?????? ???????
		validate_data(frm);
	},
	
	after_save: function(frm) {
		// ??? ?????
		frappe.show_alert({
			message: __('?? ??? ?????? ?????? ?????'),
			indicator: 'green'
		}, 3);
	},
	
	// ============================================
	// Field Events
	// ============================================
	
	mobile: function(frm) {
		// ??? ????? ??? ??????
		if (frm.doc.mobile) {
			// ????? ??? ??????
			format_mobile(frm);
			
			// ?????? ?? ???????
			check_duplicate_mobile(frm);
		}
	},
	
	email: function(frm) {
		// ??? ????? ?????? ??????????
		if (frm.doc.email) {
			validate_email(frm);
		}
	},
	
	date_of_birth: function(frm) {
		// ??? ????? ????? ???????
		if (frm.doc.date_of_birth) {
			calculate_and_show_age(frm);
		}
	},
	
	national_id: function(frm) {
		// ??? ????? ??? ??????
		if (frm.doc.national_id) {
			check_duplicate_national_id(frm);
		}
	},
	
	status: function(frm) {
		// ??? ????? ??????
		toggle_fields_based_on_status(frm);
		
		if (frm.doc.status === '?????') {
			frappe.msgprint({
				title: __('?????'),
				message: __('?? ??? ??????. ?? ????? ?? ????? ??????.'),
				indicator: 'red'
			});
		}
	},
	
	// ============================================
	// Custom Button Events
	// ============================================
	
	view_medications: function(frm) {
		// ??? ????? ??????
		frappe.route_options = {
			"patient": frm.doc.name
		};
		frappe.set_route("List", "Medication Schedule");
	},
	
	view_consultations: function(frm) {
		// ??? ???????? ??????
		frappe.route_options = {
			"patient": frm.doc.name
		};
		frappe.set_route("List", "Medical Consultation");
	},
	
	view_prescriptions: function(frm) {
		// ??? ????? ??????
		frappe.route_options = {
			"patient": frm.doc.name
		};
		frappe.set_route("List", "Medical Prescription");
	},
	
	send_notification: function(frm) {
		// ????? ????? ??????
		let d = new frappe.ui.Dialog({
			title: __('????? ?????'),
			fields: [
				{
					label: __('???????'),
					fieldname: 'title',
					fieldtype: 'Data',
					reqd: 1
				},
				{
					label: __('???????'),
					fieldname: 'message',
					fieldtype: 'Small Text',
					reqd: 1
				},
				{
					label: __('?????'),
					fieldname: 'type',
					fieldtype: 'Select',
					options: ['?????\n?????\n??????\n????'],
					default: '?????'
				}
			],
			primary_action_label: __('?????'),
			primary_action(values) {
				frappe.call({
					method: 'my_medicinal.api.send_patient_notification',
					args: {
						patient_id: frm.doc.name,
						title: values.title,
						message: values.message,
						type: values.type
					},
					callback: function(r) {
						if (r.message.success) {
							frappe.show_alert({
								message: __('?? ????? ???????'),
								indicator: 'green'
							});
							d.hide();
						}
					}
				});
			}
		});
		d.show();
	},
	
	generate_report: function(frm) {
		// ????? ????? ??????
		frappe.call({
			method: 'my_medicinal.api.generate_patient_report',
			args: {
				patient_id: frm.doc.name,
				report_type: 'summary'
			},
			callback: function(r) {
				if (r.message.success) {
					// ????? ???????
					window.open(r.message.file_url);
				}
			}
		});
	}
});

// ============================================
// Helper Functions
// ============================================

function setup_custom_buttons(frm) {
	// ????? ????? ?????
	if (!frm.is_new()) {
		// ????? ??? "???"
		frm.add_custom_button(__('???????'), function() {
			frm.trigger('view_medications');
		}, __('???'));
		
		frm.add_custom_button(__('??????????'), function() {
			frm.trigger('view_consultations');
		}, __('???'));
		
		frm.add_custom_button(__('???????'), function() {
			frm.trigger('view_prescriptions');
		}, __('???'));
		
		// ????? ??? "???????"
		frm.add_custom_button(__('????? ?????'), function() {
			frm.trigger('send_notification');
		}, __('???????'));
		
		frm.add_custom_button(__('????? ?????'), function() {
			frm.trigger('generate_report');
		}, __('???????'));
		
		// ?? ???? ?????? ????
		frm.page.set_inner_btn_group_as_primary(__('???'));
		
		frm.add_custom_button(__('????? ????'), function() {
			frappe.new_doc('Medication Schedule', {
				patient: frm.doc.name
			});
		});
	}
}

function setup_indicators(frm) {
	// ????? ?????? ??????
	if (!frm.is_new()) {
		// ???? ??????
		let indicator_color = {
			'???': 'green',
			'??? ???': 'orange',
			'?????': 'red'
		};
		
		frm.page.set_indicator(
			__(frm.doc.status),
			indicator_color[frm.doc.status]
		);
		
		// ??? ?????
		if (frm.doc.date_of_birth) {
			let age = calculate_age(frm.doc.date_of_birth);
			frm.set_df_property('date_of_birth', 'description', 
				`?????: ${age} ???`);
		}
	}
}

function setup_dashboard(frm) {
	// ????? Dashboard
	if (!frm.is_new()) {
		frappe.call({
			method: 'my_medicinal.patient.patient.get_patient_summary',
			args: {
				patient_id: frm.doc.name
			},
			callback: function(r) {
				if (r.message && r.message.success) {
					let data = r.message.data;
					
					// ??? ??????????
					frm.dashboard.add_indicator(
						__('??????? ??????: {0}', [data.medications_count]),
						'blue'
					);
					
					frm.dashboard.add_indicator(
						__('???? ????????: {0}%', [data.adherence_rate]),
						data.adherence_rate > 80 ? 'green' : 'orange'
					);
					
					frm.dashboard.add_indicator(
						__('??????? ??????: {0}', [data.active_prescriptions.length]),
						'blue'
					);
				}
			}
		});
	}
}

function set_queries(frm) {
	// ????? ???????? ?? ??????
	
	// ????? ?????????? (Patient Role ???)
	frm.set_query('user', function() {
		return {
			filters: {
				'user_type': 'Website User'
			}
		};
	});
	
	// ????? ?????????
	frm.set_query('caregiver_user', function() {
		return {
			filters: {
				'user_type': 'System User'
			}
		};
	});
}

function apply_permissions(frm) {
	// ????? ?????????
	
	// ??? ??? ???????? ????? ????? ????? ??????? ???
	if (frappe.user_roles.includes('Patient') && 
	    !frappe.user_roles.includes('System Manager')) {
		
		// ????? ??? ??????
		frm.set_df_property('status', 'read_only', 1);
		frm.set_df_property('user', 'read_only', 1);
		frm.set_df_property('caregiver_user', 'read_only', 1);
	}
}

function toggle_fields_based_on_status(frm) {
	// ?????/????? ???? ??? ??????
	if (frm.doc.status === '?????') {
		frm.set_df_property('medical_notes', 'reqd', 1);
		frm.set_df_property('medical_notes', 'description', 
			'?????? ????? ??? ?????');
	} else {
		frm.set_df_property('medical_notes', 'reqd', 0);
		frm.set_df_property('medical_notes', 'description', '');
	}
}

function format_mobile(frm) {
	// ????? ??? ?????? (????? ???????? ???????)
	let mobile = frm.doc.mobile.replace(/\s+/g, '').replace(/[^\d]/g, '');
	
	if (mobile.length === 10 && mobile.startsWith('05')) {
		frm.set_value('mobile', mobile);
	} else if (mobile.length === 12 && mobile.startsWith('9665')) {
		// ????? 9665xxxxxxxx ??? 05xxxxxxxx
		frm.set_value('mobile', '0' + mobile.substring(3));
	}
}

function check_duplicate_mobile(frm) {
	// ?????? ?? ????? ??? ??????
	if (frm.doc.mobile && frm.is_new()) {
		frappe.call({
			method: 'frappe.client.get_count',
			args: {
				doctype: 'Patient',
				filters: {
					mobile: frm.doc.mobile
				}
			},
			callback: function(r) {
				if (r.message > 0) {
					frappe.msgprint({
						title: __('?????'),
						message: __('??? ?????? ?????? ??????'),
						indicator: 'orange'
					});
				}
			}
		});
	}
}

function check_duplicate_national_id(frm) {
	// ?????? ?? ????? ??? ??????
	if (frm.doc.national_id && frm.is_new()) {
		frappe.call({
			method: 'frappe.client.get_count',
			args: {
				doctype: 'Patient',
				filters: {
					national_id: frm.doc.national_id
				}
			},
			callback: function(r) {
				if (r.message > 0) {
					frappe.msgprint({
						title: __('?????'),
						message: __('??? ?????? ?????? ??????'),
						indicator: 'orange'
					});
				}
			}
		});
	}
}

function validate_email(frm) {
	// ?????? ?? ??? ?????? ??????????
	let email = frm.doc.email;
	let email_regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
	
	if (!email_regex.test(email)) {
		frappe.msgprint({
			title: __('???'),
			message: __('?????? ?????????? ??? ????'),
			indicator: 'red'
		});
		frm.set_value('email', '');
	}
}

function calculate_age(date_of_birth) {
	// ???? ?????
	let dob = new Date(date_of_birth);
	let today = new Date();
	let age = today.getFullYear() - dob.getFullYear();
	let m = today.getMonth() - dob.getMonth();
	
	if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
		age--;
	}
	
	return age;
}

function calculate_and_show_age(frm) {
	// ???? ???? ?????
	if (frm.doc.date_of_birth) {
		let age = calculate_age(frm.doc.date_of_birth);
		
		frappe.show_alert({
			message: __('?????: {0} ???', [age]),
			indicator: 'blue'
		}, 3);
		
		// ??? ?? description
		frm.set_df_property('date_of_birth', 'description', 
			`?????: ${age} ???`);
	}
}

function validate_data(frm) {
	// ?????? ??????? ?? ????????
	let errors = [];
	
	// ?????? ?? ??? ??????
	if (!frm.doc.mobile || frm.doc.mobile.length !== 10) {
		errors.push('The mobile number must be 10 digits');
	}
	
	// ?????? ?? ?????
	if (frm.doc.date_of_birth) {
		let age = calculate_age(frm.doc.date_of_birth);
		if (age < 0 || age > 150) {
			errors.push('????? ??????? ??? ????');
		}
	}
	
	// ??? ???????
	if (errors.length > 0) {
		frappe.throw({
			title: __('????? ?? ????????'),
			message: errors.join('<br>')
		});
	}
}

// ============================================
// Keyboard Shortcuts
// ============================================

frappe.ui.keys.add_shortcut({
	shortcut: 'ctrl+m',
	action: () => {
		let frm = cur_frm;
		if (frm && frm.doctype === 'Patient' && !frm.is_new()) {
			frm.trigger('view_medications');
		}
	},
	description: __('View Patient Medications'),
	page: 'Form/Patient'
});